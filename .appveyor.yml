version: 0.0.{build}-{branch}
image: Visual Studio 2019
shallow_clone: true

environment:
  matrix:

    - RENDERER: vulkan
      CONFIG: Release
      ARCH: amd64
      TESTS: ON
      PUBLISH: ON

    - RENDERER: vulkan
      CONFIG: Debug
      ARCH: amd64
      TESTS: ON
      PUBLISH: OFF

    - RENDERER: opengl
      CONFIG: Release
      ARCH: amd64
      TESTS: ON
      PUBLISH: ON

    - RENDERER: opengl
      CONFIG: Debug
      ARCH: amd64
      TESTS: ON
      PUBLISH: OFF

    # This job builds the project from Visual Studio solution generated by CMake.
    # It ensures it is a valid way to build Yttrium.
    - RENDERER: none
      CONFIG: Debug,Release
      ARCH: x86
      TESTS: OFF
      PUBLISH: OFF

cache:
  - _build\_PrimalDownloads

install:
  - cmake --version
  - call "C:\Program Files (x86)\Microsoft Visual Studio\2019\Community\VC\Auxiliary\Build\vcvarsall.bat" %ARCH%
  - if "%RENDERER%"=="vulkan" cinst vulkan-sdk
  - ps: if ($env:RENDERER -eq "vulkan") { $Env:VULKAN_SDK = "C:\VulkanSDK\" + (Get-ChildItem "C:\VulkanSDK" -Name) }
  - if "%TESTS%"=="ON" cinst ninja

build_script:
  - set BUILD_DIR=%APPVEYOR_BUILD_FOLDER%\_build
  - set INSTALL_DIR=%APPVEYOR_BUILD_FOLDER%\_install
  - if "%TESTS%"=="ON" cmake -S %APPVEYOR_BUILD_FOLDER% -B %BUILD_DIR% -G Ninja %APPVEYOR_BUILD_FOLDER% -DCMAKE_BUILD_TYPE=%CONFIG% -DCMAKE_INSTALL_PREFIX=%INSTALL_DIR% -DYTTRIUM_EXAMPLES=ON -DYTTRIUM_RENDERER=%RENDERER% -DYTTRIUM_TESTS=%TESTS%
  - if "%TESTS%"=="ON" cmake --build %BUILD_DIR%
  - if "%TESTS%"=="ON" cmake --build %BUILD_DIR% --target install
  - if not "%TESTS%"=="ON" cmake -S %APPVEYOR_BUILD_FOLDER% -B %BUILD_DIR% -G "Visual Studio 16 2019" -A Win32 %APPVEYOR_BUILD_FOLDER% -DCMAKE_INSTALL_PREFIX=%INSTALL_DIR% -DYTTRIUM_EXAMPLES=ON -DYTTRIUM_RENDERER=%RENDERER% -DYTTRIUM_TESTS=%TESTS% -DYTTRIUM_WITH_JPEG=OFF -DYTTRIUM_WITH_OGGVORBIS=OFF
  - if not "%TESTS%"=="ON" cmake --build %BUILD_DIR% --parallel --config Debug -- /nologo
  - if not "%TESTS%"=="ON" cmake --build %BUILD_DIR% --parallel --config Release -- /nologo
  - if not "%TESTS%"=="ON" cmake --build %BUILD_DIR% --parallel --config Release --target install -- /nologo
  - cd %APPVEYOR_BUILD_FOLDER%
  - set BUILD_NAME=yttrium-%RENDERER%-%ARCH%
  - if "%PUBLISH%"=="ON" move %INSTALL_DIR% %BUILD_NAME%

test_script:
  - cd %BUILD_DIR%
  - if "%TESTS%"=="ON" ctest --output-on-failure

artifacts:
  - path: $(BUILD_NAME)
    type: zip
